<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Noise Cancellation Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        button { padding: 10px 20px; margin: 10px; }
        #status { margin: 20px; color: #333; }
        .error { color: red; }
        .success { color: green; }
        .controls { margin: 20px; }
        input[type="range"] { width: 200px; }
        label { display: block; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Software-Based Active Noise Cancellation Demo</h1>
    <p>This demo uses Web Audio API to apply a low-pass filter for basic noise reduction. Wear headphones for best results. Ensure you're on HTTPS for microphone access.</p>
    
    <button id="checkPermBtn">Check Microphone Permission</button>
    <button id="requestPermBtn">Request Microphone Permission</button>
    <button id="startBtn" disabled>Start ANC</button>
    <button id="stopBtn" disabled>Stop ANC</button>
    <button id="playToneBtn" disabled>Play Test Tone</button>
    <div id="status">Click "Check Microphone Permission" first.</div>
    
    <div class="controls">
        <label>Filter Frequency: <span id="freqValue">1000</span> Hz</label>
        <input type="range" id="freqSlider" min="100" max="5000" value="1000" step="50">
        
        <label>Filter Q (Sharpness): <span id="qValue">1</span></label>
        <input type="range" id="qSlider" min="0.1" max="10" value="1" step="0.1">
    </div>
    
    <script>
        let audioContext, source, filter, destination, oscillator;
        const statusDiv = document.getElementById('status');
        const freqSlider = document.getElementById('freqSlider');
        const qSlider = document.getElementById('qSlider');
        const freqValue = document.getElementById('freqValue');
        const qValue = document.getElementById('qValue');
        
        // Update display values
        freqSlider.addEventListener('input', () => {
            freqValue.textContent = freqSlider.value;
            if (filter) filter.frequency.value = freqSlider.value;
        });
        qSlider.addEventListener('input', () => {
            qValue.textContent = qSlider.value;
            if (filter) filter.Q.value = qSlider.value;
        });
        
        // Check permission status (if supported)
        document.getElementById('checkPermBtn').addEventListener('click', async () => {
            if (navigator.permissions) {
                try {
                    const permission = await navigator.permissions.query({ name: 'microphone' });
                    statusDiv.textContent = `Microphone permission: ${permission.state}`;
                    statusDiv.className = permission.state === 'granted' ? 'success' : permission.state === 'denied' ? 'error' : '';
                    if (permission.state === 'granted') {
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('playToneBtn').disabled = false;
                    }
                } catch (err) {
                    statusDiv.textContent = 'Permissions API not supported. Try requesting permission directly.';
                    statusDiv.className = 'error';
                }
            } else {
                statusDiv.textContent = 'Permissions API not available. Proceed to request permission.';
                statusDiv.className = '';
            }
        });
        
        // Explicitly request permission
        document.getElementById('requestPermBtn').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // Stop immediately after granting
                statusDiv.textContent = 'Microphone permission granted!';
                statusDiv.className = 'success';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('playToneBtn').disabled = false;
            } catch (err) {
                statusDiv.textContent = 'Permission denied or error: ' + err.message;
                statusDiv.className = 'error';
            }
        });
        
        document.getElementById('startBtn').addEventListener('click', async () => {
            try {
                // Request microphone access (should prompt if not already granted)
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create source from microphone
                source = audioContext.createMediaStreamSource(stream);
                
                // Create low-pass filter for noise reduction (cuts high frequencies)
                filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = freqSlider.value;
                filter.Q.value = qSlider.value;
                
                // Connect: source -> filter -> destination (speakers)
                source.connect(filter);
                filter.connect(audioContext.destination);
                
                // Update UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                statusDiv.textContent = 'ANC active. Adjust sliders for calibration.';
                statusDiv.className = 'success';
                
            } catch (err) {
                statusDiv.textContent = 'Error starting ANC: ' + err.message + '. Check permissions and try again.';
                statusDiv.className = 'error';
            }
        });
        
        document.getElementById('stopBtn').addEventListener('click', () => {
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                source = null;
                filter = null;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('playToneBtn').disabled = false;
                statusDiv.textContent = 'ANC stopped.';
                statusDiv.className = '';
            }
        });
        
        // Play test tone for calibration
        document.getElementById('playToneBtn').addEventListener('click', () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (oscillator) {
                oscillator.stop();
            }
            // Create oscillator for test tone (2000 Hz sine wave)
            oscillator = audioContext.createOscillator();
            oscillator.frequency.value = 2000;
            oscillator.type = 'sine';
            
            // Create filter if not already (for tone testing)
            if (!filter) {
                filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = freqSlider.value;
                filter.Q.value = qSlider.value;
            }
            
            // Connect: oscillator -> filter -> destination
            oscillator.connect(filter);
            filter.connect(audioContext.destination);
            
            oscillator.start();
            statusDiv.textContent = 'Playing test tone (2000 Hz). Adjust sliders to hear filtering. Click again to stop.';
            statusDiv.className = 'success';
            
            // Stop after 5 seconds or on next click
            setTimeout(() => {
                if (oscillator) {
                    oscillator.stop();
                    oscillator = null;
                    statusDiv.textContent = 'Test tone stopped.';
                }
            }, 5000);
        });
    </script>
</body>
</html>