<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Noise Reduction Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        button { padding: 10px 20px; margin: 10px; }
        #status { margin: 20px; color: #333; }
        .error { color: red; }
        .success { color: green; }
        .controls { margin: 20px; }
        input[type="range"] { width: 200px; }
        label { display: block; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Enhanced Software-Based Noise Reduction Demo</h1>
    <p>This uses Tone.js for adaptive filtering and noise gating to reduce noise in your mic input. Not true ANC, but better at attenuating background sounds. Wear headphones.</p>
    
    <button id="checkPermBtn">Check Microphone Permission</button>
    <button id="requestPermBtn">Request Microphone Permission</button>
    <button id="startBtn" disabled>Start Noise Reduction</button>
    <button id="stopBtn" disabled>Stop Noise Reduction</button>
    <button id="playToneBtn" disabled>Play Test Tone</button>
    <div id="status">Click "Check Microphone Permission" first.</div>
    
    <div class="controls">
        <label>Filter Frequency: <span id="freqValue">1000</span> Hz</label>
        <input type="range" id="freqSlider" min="100" max="5000" value="1000" step="50">
        
        <label>Noise Gate Threshold: <span id="gateValue">-30</span> dB</label>
        <input type="range" id="gateSlider" min="-60" max="-10" value="-30" step="1">
    </div>
    
    <script>
        let mic, filter, gate;
        const statusDiv = document.getElementById('status');
        const freqSlider = document.getElementById('freqSlider');
        const gateSlider = document.getElementById('gateSlider');
        const freqValue = document.getElementById('freqValue');
        const gateValue = document.getElementById('gateValue');
        
        // Update display values and apply to filters
        freqSlider.addEventListener('input', () => {
            freqValue.textContent = freqSlider.value;
            if (filter) filter.frequency.value = freqSlider.value;
        });
        gateSlider.addEventListener('input', () => {
            gateValue.textContent = gateSlider.value;
            if (gate) gate.threshold.value = gateSlider.value;
        });
        
        // Check permission status
        document.getElementById('checkPermBtn').addEventListener('click', async () => {
            if (navigator.permissions) {
                try {
                    const permission = await navigator.permissions.query({ name: 'microphone' });
                    statusDiv.textContent = `Microphone permission: ${permission.state}`;
                    statusDiv.className = permission.state === 'granted' ? 'success' : permission.state === 'denied' ? 'error' : '';
                    if (permission.state === 'granted') {
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('playToneBtn').disabled = false;
                    }
                } catch (err) {
                    statusDiv.textContent = 'Permissions API not supported.';
                    statusDiv.className = 'error';
                }
            } else {
                statusDiv.textContent = 'Permissions API not available.';
                statusDiv.className = '';
            }
        });
        
        // Request permission
        document.getElementById('requestPermBtn').addEventListener('click', async () => {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                statusDiv.textContent = 'Microphone permission granted!';
                statusDiv.className = 'success';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('playToneBtn').disabled = false;
            } catch (err) {
                statusDiv.textContent = 'Permission denied: ' + err.message;
                statusDiv.className = 'error';
            }
        });
        
        document.getElementById('startBtn').addEventListener('click', async () => {
            try {
                await Tone.start(); // Required for Tone.js
                
                // Create mic input
                mic = new Tone.UserMedia();
                await mic.open();
                
                // Create low-pass filter
                filter = new Tone.Filter(freqSlider.value, 'lowpass');
                
                // Create noise gate (silences low-level noise)
                gate = new Tone.Gate(gateSlider.value, 0.1);
                
                // Chain: mic -> filter -> gate -> output
                mic.connect(filter);
                filter.connect(gate);
                gate.toDestination();
                
                statusDiv.textContent = 'Noise reduction active. Adjust controls.';
                statusDiv.className = 'success';
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
            } catch (err) {
                statusDiv.textContent = 'Error: ' + err.message;
                statusDiv.className = 'error';
            }
        });
        
        document.getElementById('stopBtn').addEventListener('click', () => {
            if (mic) mic.close();
            mic = null;
            filter = null;
            gate = null;
            statusDiv.textContent = 'Noise reduction stopped.';
            statusDiv.className = '';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('playToneBtn').disabled = false;
        });
        
        // Play test tone
        document.getElementById('playToneBtn').addEventListener('click', () => {
            const synth = new Tone.Synth().toDestination();
            synth.triggerAttackRelease('C4', '4n'); // Short tone
            statusDiv.textContent = 'Test tone played.';
        });
    </script>
</body>
</html>